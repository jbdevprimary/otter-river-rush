name: Continuous Deployment

# This workflow handles all deployment tasks:
# - Deploy web to GitHub Pages
# - Build and publish Android APKs
# - Upload to Google Play Store (on releases)
#
# Triggered by:
# - Successful CI completion on main branch
# - workflow_dispatch for manual deployments
# - Called by release-please on new releases

on:
  workflow_run:
    workflows: ["Continuous Integration"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy_web:
        description: 'Deploy to GitHub Pages'
        type: boolean
        default: true
      build_android:
        description: 'Build Android APK'
        type: boolean
        default: true
      upload_play_store:
        description: 'Upload to Google Play Store'
        type: boolean
        default: false
      release_version:
        description: 'Release version (e.g., v1.0.0) - leave empty for snapshot'
        type: string
        required: false
  workflow_call:
    inputs:
      release_version:
        description: 'Release version from release-please'
        type: string
        required: false
    secrets:
      ANDROID_KEYSTORE_BASE64:
        required: false
      ANDROID_KEY_ALIAS:
        required: false
      ANDROID_KEYSTORE_PASSWORD:
        required: false
      ANDROID_KEY_PASSWORD:
        required: false
      GOOGLE_PLAY_JSON_KEY:
        required: false

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Only run if CI passed or manually triggered
  check-ci:
    name: Check CI Status
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    steps:
      - name: Check if deployment should proceed
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "Manual deployment triggered"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "workflow_call" ]]; then
            echo "Called by release-please workflow"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.workflow_run.conclusion }}" == "success" ]]; then
            echo "CI passed, proceeding with deployment"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "CI failed or not applicable, skipping deployment"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

  # Deploy web to GitHub Pages
  deploy-pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: check-ci
    if: |
      needs.check-ci.outputs.should_deploy == 'true' &&
      (github.event_name == 'workflow_run' ||
       github.event_name == 'workflow_call' ||
       (github.event_name == 'workflow_dispatch' && inputs.deploy_web))
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Install dependencies
        uses: ./.github/actions/install-deps

      - name: Build web bundle
        uses: ./.github/actions/build-web

      - name: Setup Pages
        uses: actions/configure-pages@983d7736d9b0ae728b81ab479565c72886d7745b  # v5.0.0

      - name: Upload to Pages
        uses: actions/upload-pages-artifact@7b1f4a764d45c48632c6b24a0339c27f5614fb0b  # v4.0.0
        with:
          path: apps/web/dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e  # v4.0.5

      - name: Deployment summary
        run: |
          echo "## ðŸŒ Web Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Deployed to: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY

  # Build Android APK
  build-android:
    name: Build Android APK
    runs-on: macos-15
    needs: check-ci
    if: |
      needs.check-ci.outputs.should_deploy == 'true' &&
      (github.event_name == 'workflow_run' ||
       github.event_name == 'workflow_call' ||
       (github.event_name == 'workflow_dispatch' && inputs.build_android))
    # Note: Capacitor not yet configured for v2.0, so continue on error
    continue-on-error: true
    outputs:
      apk_built: ${{ steps.build-status.outputs.success }}

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Install dependencies
        uses: ./.github/actions/install-deps

      - name: Build web bundle
        uses: ./.github/actions/build-web

      - name: Setup Android SDK
        uses: ./.github/actions/setup-android

      - name: Capacitor sync
        run: pnpm exec cap sync android
        working-directory: .

      - name: Build Debug APK
        uses: gradle/actions/setup-gradle@f236b35da9d031e13b1005234ebe4392ed54c580  # v5.0.0
        with:
          gradle-version: wrapper
          arguments: assembleDebug
          build-root-directory: android
          cache-read-only: false

      - name: Build Release APK
        uses: gradle/actions/setup-gradle@f236b35da9d031e13b1005234ebe4392ed54c580  # v5.0.0
        with:
          gradle-version: wrapper
          arguments: assembleRelease
          build-root-directory: android
          cache-read-only: false

      - name: Sign Release APK (if secrets available)
        if: env.ANDROID_KEYSTORE_BASE64 != ''
        uses: r0adkll/sign-android-release@dbeba6b98a60b0fd540c02443c7f428cdedf0e7f  # v1.0.4
        with:
          releaseDirectory: android/app/build/outputs/apk/release
          signingKeyBase64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          alias: ${{ secrets.ANDROID_KEY_ALIAS }}
          keyStorePassword: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword: ${{ secrets.ANDROID_KEY_PASSWORD }}
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}

      - name: Upload Debug APK
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5.0.0
        with:
          name: app-debug-apk-${{ github.sha }}
          path: android/app/build/outputs/apk/debug/*.apk
          retention-days: 30

      - name: Upload Release APK
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5.0.0
        with:
          name: app-release-apk-${{ github.sha }}
          path: android/app/build/outputs/apk/release/*.apk
          retention-days: 90

      - name: Set build status
        id: build-status
        run: echo "success=true" >> $GITHUB_OUTPUT

      - name: Build summary
        run: |
          echo "## ðŸ“± Android Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Debug APK built successfully" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Release APK built successfully" >> $GITHUB_STEP_SUMMARY

  # Upload to Google Play Store (only on releases or manual trigger)
  upload-play-store:
    name: Upload to Google Play
    runs-on: ubuntu-latest
    needs: build-android
    if: |
      needs.build-android.outputs.apk_built == 'true' &&
      (github.event_name == 'workflow_call' ||
       (github.event_name == 'workflow_dispatch' && inputs.upload_play_store))

    steps:
      - name: Download Release APK
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53  # v6.0.0
        with:
          name: app-release-apk-${{ github.sha }}
          path: apk/

      - name: Upload to Google Play
        if: env.GOOGLE_PLAY_JSON_KEY != ''
        uses: r0adkll/upload-google-play@935ef9c68bb393a8e6116b1575626a7f5be3a7fb  # v1.1.3
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_JSON_KEY }}
          packageName: com.ottergames.riverrush
          releaseFiles: apk/*.apk
          track: internal
        env:
          GOOGLE_PLAY_JSON_KEY: ${{ secrets.GOOGLE_PLAY_JSON_KEY }}

      - name: Upload summary
        run: |
          echo "## ðŸ“¤ Google Play Upload" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… APK uploaded to internal track" >> $GITHUB_STEP_SUMMARY

  # Create GitHub Release (if version provided)
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-android]
    if: |
      (github.event_name == 'workflow_call' || github.event_name == 'workflow_dispatch') &&
      (inputs.release_version != '' && inputs.release_version != null)

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Download APKs
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53  # v6.0.0
        with:
          pattern: app-*-apk-${{ github.sha }}
          path: release-artifacts/
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b  # v2.5.0
        with:
          tag_name: ${{ inputs.release_version }}
          files: release-artifacts/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          echo "## ðŸŽ‰ GitHub Release" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Release ${{ inputs.release_version }} created" >> $GITHUB_STEP_SUMMARY

  # Overall deployment summary
  cd-summary:
    name: CD Summary
    runs-on: ubuntu-latest
    needs: [deploy-pages, build-android, upload-play-store, create-release]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Results" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Pages: ${{ needs.deploy-pages.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Android Build: ${{ needs.build-android.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Google Play Upload: ${{ needs.upload-play-store.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Release: ${{ needs.create-release.result }}" >> $GITHUB_STEP_SUMMARY
