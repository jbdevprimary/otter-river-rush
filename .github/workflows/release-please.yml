name: Release Please

# Automated versioning using release-please
# Creates a release PR based on conventional commits (feat:, fix:, BREAKING CHANGE:)
# When the PR is merged, it creates a GitHub release and triggers platform builds
#
# IMPORTANT SETUP INSTRUCTIONS:
# =============================
# This workflow requires a custom GitHub token with PR creation permissions.
# 
# To configure:
# 1. Create a Personal Access Token (classic) or fine-grained token with these permissions:
#    - For classic PAT: 'repo' scope (full control of private repositories)
#    - For fine-grained: 'Contents: Read and write', 'Pull requests: Read and write'
# 2. Add the token as a repository secret named 'CI_GITHUB_TOKEN':
#    Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret
# 3. Name: CI_GITHUB_TOKEN
#    Value: <your-token>
#
# WHY THIS IS NEEDED:
# The default GITHUB_TOKEN has restrictions that prevent it from creating or approving
# pull requests when workflow files are modified, which is a GitHub security feature.
# release-please needs to create PRs, so we use a custom token with appropriate permissions.
#
# TROUBLESHOOTING:
# ================
# If you see "GitHub Actions is not permitted to create or approve pull requests":
# - Verify CI_GITHUB_TOKEN secret is set in repository settings
# - Check that the token has not expired
# - Ensure the token has 'repo' or equivalent permissions
#
# If you see commit parsing errors (e.g., "unexpected token ' ' at 1:3"):
# - This is expected for commits that don't follow conventional commit format
# - release-please will skip these commits when generating changelogs
# - The workflow will continue and create releases based on valid conventional commits
# - To reduce noise, use conventional commit format: type(scope): description
#   Examples: feat: add new feature, fix: resolve bug, docs: update readme
#
# Common commit types: feat, fix, docs, style, refactor, perf, test, build, ci, chore

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    name: Release Please
    runs-on: ubuntu-latest
    
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
    
    steps:
      # Check if CI_GITHUB_TOKEN is configured (fail fast if not)
      - name: Validate Token Configuration
        run: |
          if [ -z "${{ secrets.CI_GITHUB_TOKEN }}" ]; then
            echo "::error::CI_GITHUB_TOKEN secret is not configured!"
            echo "::error::This workflow requires a custom token with PR creation permissions."
            echo "::error::See workflow comments for setup instructions."
            exit 1
          else
            echo "âœ… CI_GITHUB_TOKEN is configured"
          fi
      
      - name: Run Release Please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          # MUST use CI_GITHUB_TOKEN - a PAT with 'repo' scope for PR creation
          # GITHUB_TOKEN will NOT work due to permission restrictions
          token: ${{ secrets.CI_GITHUB_TOKEN }}
          release-type: node
          package-name: otter-river-rush
          changelog-types: |
            [
              {"type":"feat","section":"âœ¨ Features","hidden":false},
              {"type":"fix","section":"ðŸ› Bug Fixes","hidden":false},
              {"type":"perf","section":"âš¡ Performance","hidden":false},
              {"type":"revert","section":"âª Reverts","hidden":false},
              {"type":"docs","section":"ðŸ“ Documentation","hidden":false},
              {"type":"style","section":"ðŸ’„ Styling","hidden":false},
              {"type":"refactor","section":"â™»ï¸ Refactoring","hidden":false},
              {"type":"test","section":"âœ… Tests","hidden":false},
              {"type":"build","section":"ðŸ—ï¸ Build System","hidden":false},
              {"type":"ci","section":"ðŸ‘· CI/CD","hidden":false},
              {"type":"chore","section":"ðŸ”§ Chores","hidden":false}
            ]
      
      # Provide feedback on commit parsing (informational only, does not fail workflow)
      - name: Commit Parsing Summary
        if: always()
        run: |
          echo "## ðŸ“‹ Commit Parsing Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "release-please parses commits using conventional commit format (e.g., 'feat:', 'fix:')." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Expected behavior:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Commits with valid format are included in changelog" >> $GITHUB_STEP_SUMMARY
          echo "- âš ï¸ Commits without valid format are skipped (this is normal)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”„ Merge commits are processed but may not follow conventional format" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Parsing warnings are informational and don't prevent releases." >> $GITHUB_STEP_SUMMARY
          echo "Only commits following conventional format will appear in the changelog." >> $GITHUB_STEP_SUMMARY
      
      - name: Release Summary
        if: steps.release.outputs.release_created == 'true'
        run: |
          echo "## ðŸŽ‰ Release ${{ steps.release.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Version: ${{ steps.release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "Tag: ${{ steps.release.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Release created successfully" >> $GITHUB_STEP_SUMMARY
      
      - name: Trigger mobile build for release
        if: steps.release.outputs.release_created == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const version = '${{ steps.release.outputs.tag_name }}';

            console.log(`ðŸš€ Triggering mobile-primary workflow for ${version}`);

            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'mobile-primary.yml',
              ref: 'main'
            });

  # Trigger EAS Android build on release
  trigger-eas-build:
    name: Trigger EAS Android Build
    runs-on: ubuntu-latest
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created == 'true' }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Trigger EAS Release Workflow
        run: |
          cd apps/mobile
          eas workflow:run .eas/workflows/release-android.yaml \
            --non-interactive \
            --input version=${{ needs.release-please.outputs.tag_name }}
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
